#!/bin/bash

log() {
  echo -e "\033[32m[INFO]\033[0m $1"
}

# 定义红色错误日志输出函数
error() {
  echo -e "\033[31m[ERROR]\033[0m $1"
}

# 检查当前用户是否有sudo权限
if ! sudo -v &>/dev/null; then
  error "Please run the script as a user with sudo privileges"
  exit 1
fi

# 新增：安装Homebrew的函数
install_homebrew() {
  if ! command -v brew &>/dev/null; then
    log "Installing Homebrew via USTC mirror..."
    
    # 设置中科大镜像环境变量
    export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.ustc.edu.cn/brew.git"
    export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.ustc.edu.cn/homebrew-core.git"
    export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"
    export HOMEBREW_API_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles/api"

    # 使用中科大每日同步的安装脚本
    /bin/bash -c "$(curl -fsSL https://mirrors.ustc.edu.cn/misc/brew-install.sh)"

    # 将brew添加到PATH
    if [ "$(uname)" = "Darwin" ]; then
      echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    else
      echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.profile
    fi
    source ~/.profile
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    
    # 初始化brew更新（使用中科大源）
    brew update
  fi
}

# 修改：替换镜像源函数（改为可选配置）
replace_mirror_brew() {
  read -rp "Verify USTC mirror configuration? [y/N]: " answer
  case $answer in
  [yY])
    log "Checking mirror configuration..."
    # 检查核心仓库配置
    if ! git -C "$(brew --repo)" remote -v | grep -q ustc.edu.cn; then
      git -C "$(brew --repo)" remote set-url origin https://mirrors.ustc.edu.cn/brew.git
    fi
    # 检查homebrew-core配置
    if ! git -C "$(brew --repo homebrew/core)" remote -v | grep -q ustc.edu.cn; then
      git -C "$(brew --repo homebrew/core)" remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git
    fi
    brew update
    ;;
  *)
    log "Skipping mirror verification"
    ;;
  esac
}

# 统一安装函数
install_packages_brew() {
  log "Installing common components..."
  
  # 基础工具
  brew install zsh tldr vim tmux curl wget openssl eza pygments antigen
  
  # Linux系统需要额外处理
  if [ "$(uname)" = "Linux" ]; then
    # 安装编译依赖
    if command -v apt-get &>/dev/null; then
      sudo apt-get install -y build-essential
    elif command -v dnf &>/dev/null || command -v yum &>/dev/null; then
      sudo $(command -v dnf || command -v yum) install -y gcc-c++ glibc-static libstdc++-static
    fi

    # 处理可能需要的特殊包
    brew install gcc
  fi
  
  # Python相关
  python3 -m pip install --user pipx
  
  log "Package installation completed."
}

# 定义函数用于配置git全局用户名和邮箱
config_git() {
  # 检查是否已经存在现有的gitconfig配置，如果有的话则输出warning信息
  if [ -f ~/.gitconfig ]; then
    log "Warning: Existing gitconfig file found. Skipping git global configuration."
    return
  fi
  read -rp "Do you want to configure git global username and email? [y/N]: " answer
  case $answer in
  [yY])
    read -rp "Enter your git username: " username
    read -rp "Enter your git email: " email
    git config --global user.name "$username"
    git config --global user.email "$email"
    log "Git global configuration completed."
    ;;
  *)
    log "Skipping git global configuration."
    ;;
  esac
}

# 定义函数用于解密加密文件
decrypt_files() {
  read -rp "Do you want to decrypt encrypted files using yadm? [y/N]: " answer
  case $answer in
  [yY])
    yadm decrypt # 这里可以添加其他需要解密的文件路径
    log "File decryption completed."
    ;;
  *)
    log "Skipping file decryption."
    ;;
  esac
}

# 主逻辑调整
if [ "$(uname)" = "Linux" ]; then
  # 检测包管理器
  if command -v apt-get &>/dev/null; then
    log "Detected APT package manager"
    sudo apt-get update
    sudo apt-get install -y build-essential procps curl file git
  elif command -v dnf &>/dev/null || command -v yum &>/dev/null; then
    log "Detected YUM/DNF package manager"
    sudo $(command -v dnf || command -v yum) install -y gcc-c++ make procps-ng curl file git
  else
    error "Unsupported package manager. Please install dependencies manually."
    exit 1
  fi
elif [ "$(uname)" = "Darwin" ]; then
  # 检查Xcode CLT
  if ! xcode-select -p &>/dev/null; then
    log "Installing Xcode Command Line Tools..."
    xcode-select --install
    # 等待安装完成
    until xcode-select -p &>/dev/null; do
      sleep 5
    done
  fi
fi

# 统一安装Homebrew
install_homebrew
replace_mirror_brew
install_packages_brew

# 配置git全局用户名和邮箱
config_git

# 解密加密文件
decrypt_files

log "Bootstrap script completed."

# 更改默认shell为zsh
if [ "$SHELL" = "/bin/zsh" ]; then
  log "Zsh is already the default shell."
else
  log "Changing the shell to zsh."
  if chsh -s "$(which zsh)"; then
    # 输出绿色信息表示成功更改默认shell
    log "Default shell changed to zsh."
    # 重新启动shell以使更改生效
    exec -l $SHELL
  else
    # 输出红色信息表示更改默认shell失败
    error "Failed to change default shell. Please try again later."
  fi
fi
